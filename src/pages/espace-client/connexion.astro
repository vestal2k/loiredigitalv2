---
import Layout from '@/layouts/Layout.astro'
import { getUserFromCookie } from '@/lib/auth'

// Si d√©j√† connect√©, rediriger vers le dashboard
const user = getUserFromCookie(Astro.cookies)
if (user) {
  return Astro.redirect('/espace-client/dashboard')
}
---

<Layout
  title="Connexion - Espace Client"
  description="Connectez-vous √† votre espace client Loire Digital pour suivre vos projets."
>
  <div class="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-md mx-auto">
      <!-- Logo -->
      <div class="text-center mb-8">
        <a href="/" class="inline-block">
          <img
            src="/images/logo.svg"
            alt="Loire Digital"
            class="h-12 mx-auto"
            width="200"
            height="48"
          />
        </a>
        <h2 class="mt-6 text-3xl font-bold text-gray-900">Espace Client</h2>
        <p class="mt-2 text-gray-600">Connectez-vous pour acc√©der √† vos projets</p>
      </div>

      <!-- Formulaire de connexion -->
      <div class="bg-white rounded-xl shadow-lg p-8">
        <form id="login-form" class="space-y-6">
          <!-- Email -->
          <div>
            <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
              Adresse email
            </label>
            <input
              type="email"
              id="email"
              name="email"
              required
              autocomplete="email"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition"
              placeholder="vous@exemple.fr"
            />
          </div>

          <!-- Mot de passe -->
          <div>
            <label for="password" class="block text-sm font-medium text-gray-700 mb-2">
              Mot de passe
            </label>
            <input
              type="password"
              id="password"
              name="password"
              required
              autocomplete="current-password"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition"
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
            />
          </div>

          <!-- Message d'erreur -->
          <div id="error-message" class="hidden bg-red-50 text-red-700 px-4 py-3 rounded-lg">
          </div>

          <!-- Bouton de connexion -->
          <button
            type="submit"
            class="w-full bg-gradient-to-r from-green-600 to-green-700 text-white py-3 rounded-lg font-semibold hover:from-green-700 hover:to-green-800 transition-all shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
            id="submit-btn"
          >
            Se connecter
          </button>
        </form>

        <!-- Liens utiles -->
        <div class="mt-6 text-center space-y-2">
          <a href="/contact" class="block text-sm text-gray-600 hover:text-green-600 transition">
            Mot de passe oubli√© ?
          </a>
          <p class="text-sm text-gray-600">
            Pas encore de compte ?
            <a href="/contact" class="text-green-600 hover:text-green-700 font-medium">
              Contactez-nous
            </a>
          </p>
        </div>
      </div>

      <!-- Info -->
      <div class="mt-8 text-center">
        <p class="text-sm text-gray-600">
          üîí Connexion s√©curis√©e - Vos donn√©es sont prot√©g√©es
        </p>
      </div>
    </div>
  </div>

  <script>
    const form = document.getElementById('login-form') as HTMLFormElement
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement
    const errorMessage = document.getElementById('error-message') as HTMLDivElement

    form.addEventListener('submit', async (e) => {
      e.preventDefault()

      // D√©sactiver le bouton
      submitBtn.disabled = true
      submitBtn.textContent = 'Connexion en cours...'
      errorMessage.classList.add('hidden')

      try {
        const formData = new FormData(form)
        const email = formData.get('email') as string
        const password = formData.get('password') as string

        const response = await fetch('/api/auth/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ email, password }),
        })

        const data = await response.json()

        if (response.ok) {
          // Rediriger vers le dashboard
          window.location.href = '/espace-client/dashboard'
        } else {
          // Afficher l'erreur
          errorMessage.textContent = data.error || 'Erreur lors de la connexion'
          errorMessage.classList.remove('hidden')
          submitBtn.disabled = false
          submitBtn.textContent = 'Se connecter'
        }
      } catch (error) {
        console.error('Login error:', error)
        errorMessage.textContent = 'Erreur de connexion. Veuillez r√©essayer.'
        errorMessage.classList.remove('hidden')
        submitBtn.disabled = false
        submitBtn.textContent = 'Se connecter'
      }
    })
  </script>
</Layout>
