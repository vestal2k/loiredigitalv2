---
import BaseLayout from '../../layouts/BaseLayout.astro'
import Icon from '../../components/Icon.astro'
import CTABlock from '../../components/CTABlock.astro'
import { getCollection, getEntry } from 'astro:content'
import { getAllBlogPosts } from '../../lib/blog'

export async function getStaticPaths() {
  const posts = await getCollection('blog')
  return posts
    .filter((post) => !post.data.draft)
    .map((post) => ({
      params: { slug: post.slug },
    }))
}

const { slug } = Astro.params
const entry = await getEntry('blog', slug)

if (!entry) {
  return Astro.redirect('/blog')
}

const { Content } = await entry.render()

const post = {
  slug: entry.slug,
  title: entry.data.title,
  description: entry.data.description,
  pubDate: entry.data.pubDate,
  author: entry.data.author,
  tags: entry.data.tags,
  image: entry.data.image,
  ogImage: entry.data.ogImage,
  keywords: entry.data.keywords,
}

const formatDate = (date: Date) => {
  return new Intl.DateTimeFormat('fr-FR', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  }).format(date)
}

// Get other posts for recommendations
const allPosts = (await getAllBlogPosts())
  .filter((p) => p.slug !== post.slug)
  .slice(0, 2)

// Generate SEO keywords from tags if not specified
const seoKeywords = post.keywords?.length
  ? post.keywords.join(', ')
  : [...post.tags, 'Loire Digital', 'Saint-Étienne', 'site web'].join(', ')

// Use ogImage if available, otherwise fall back to image or default
const ogImageUrl = post.ogImage || post.image || '/og-image.jpg'
---

<BaseLayout
  title={`${post.title} | Loire Digital`}
  description={post.description}
  ogImage={ogImageUrl}
>
  <!-- Additional SEO meta tags for blog posts -->
  <meta slot="head" name="keywords" content={seoKeywords} />
  <meta slot="head" property="article:published_time" content={post.pubDate.toISOString()} />
  <meta slot="head" property="article:author" content={post.author} />
  {post.tags.map((tag: string) => (
    <meta slot="head" property="article:tag" content={tag} />
  ))}

  <!-- Article Schema.org structured data -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "Article",
    "headline": post.title,
    "description": post.description,
    "image": post.image || post.ogImage,
    "keywords": seoKeywords,
    "author": {
      "@type": "Person",
      "name": post.author
    },
    "datePublished": post.pubDate.toISOString(),
    "publisher": {
      "@type": "Organization",
      "name": "Loire Digital",
      "logo": {
        "@type": "ImageObject",
        "url": new URL('/logo.svg', Astro.site).toString()
      }
    },
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": Astro.url.href
    }
  })} />

  <!-- Article Header -->
  <article class="py-12 section-white">
    <div class="container mx-auto px-4">
      <div class="max-w-4xl mx-auto">
        <!-- Breadcrumb -->
        <nav class="mb-8 text-sm">
          <ol class="flex items-center space-x-2 text-charbon">
            <li><a href="/" class="hover:text-or transition-colors">Accueil</a></li>
            <li><span class="mx-2 text-gris-moyen">/</span></li>
            <li><a href="/blog" class="hover:text-or transition-colors">Blog</a></li>
            <li><span class="mx-2 text-gris-moyen">/</span></li>
            <li class="text-gris-moyen truncate">{post.title}</li>
          </ol>
        </nav>

        <!-- Tags -->
        <div class="flex flex-wrap gap-2 mb-6">
          {
            post.tags.map((tag: string) => (
              <span class="text-xs bg-or/10 text-or px-3 py-1 rounded-full font-semibold capitalize">
                {tag}
              </span>
            ))
          }
        </div>

        <!-- Title -->
        <h1 class="text-4xl md:text-6xl font-serif font-bold text-noir mb-6 leading-tight">
          {post.title}
        </h1>

        <!-- Meta -->
        <div class="flex items-center text-charbon mb-8 pb-8 border-b border-gris-doux">
          <div class="flex items-center">
            <div class="w-12 h-12 bg-or rounded-full flex items-center justify-center mr-4">
              <span class="text-white font-serif font-bold text-lg">LD</span>
            </div>
            <div>
              <div class="font-serif font-semibold text-noir">{post.author}</div>
              <div class="text-sm flex items-center text-charbon">
                <svg class="w-4 h-4 mr-1 text-or" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="1.5"
                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                  ></path>
                </svg>
                <time datetime={post.pubDate.toISOString()}>
                  {formatDate(post.pubDate)}
                </time>
              </div>
            </div>
          </div>
        </div>

        <!-- Article Content -->
        <div
          class="prose prose-lg max-w-none
          prose-headings:font-serif prose-headings:font-bold prose-headings:text-noir
          prose-h1:text-4xl prose-h2:text-3xl prose-h3:text-2xl
          prose-p:text-charbon prose-p:leading-relaxed
          prose-a:text-or prose-a:no-underline hover:prose-a:text-or-light prose-a:transition-colors
          prose-strong:text-noir prose-strong:font-semibold
          prose-ul:text-charbon prose-ol:text-charbon
          prose-li:text-charbon prose-li:marker:text-or
          prose-code:text-or prose-code:bg-creme prose-code:px-2 prose-code:py-1 prose-code:rounded-elegant prose-code:font-normal
          prose-pre:bg-noir prose-pre:border prose-pre:border-gris-doux prose-pre:rounded-elegant
          prose-blockquote:border-l-or prose-blockquote:border-l-4 prose-blockquote:text-charbon prose-blockquote:italic prose-blockquote:pl-6
          prose-hr:border-gris-doux"
        >
          <Content />
        </div>

        <!-- Share Buttons -->
        <div class="mt-12 pt-8 border-t border-gris-doux">
          <h3 class="text-lg font-serif font-bold text-noir mb-4">Partager cet article</h3>
          <div class="flex gap-3">
            <a
              href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(post.title)}&url=${encodeURIComponent(Astro.url.href)}`}
              target="_blank"
              rel="noopener noreferrer"
              class="px-4 py-2 bg-white hover:bg-creme border border-gris-doux rounded-elegant text-charbon font-medium transition-colors hover:border-or hover:text-or"
            >
              Twitter
            </a>
            <a
              href={`https://www.linkedin.com/shareArticle?mini=true&url=${encodeURIComponent(Astro.url.href)}&title=${encodeURIComponent(post.title)}`}
              target="_blank"
              rel="noopener noreferrer"
              class="px-4 py-2 bg-white hover:bg-creme border border-gris-doux rounded-elegant text-charbon font-medium transition-colors hover:border-or hover:text-or"
            >
              LinkedIn
            </a>
            <a
              href={`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(Astro.url.href)}`}
              target="_blank"
              rel="noopener noreferrer"
              class="px-4 py-2 bg-white hover:bg-creme border border-gris-doux rounded-elegant text-charbon font-medium transition-colors hover:border-or hover:text-or"
            >
              Facebook
            </a>
          </div>
        </div>
      </div>
    </div>
  </article>

  <!-- Related Articles -->
  {
    allPosts.length > 0 && (
      <section class="py-20 section-creme">
        <div class="container mx-auto px-4">
          <div class="max-w-5xl mx-auto">
            <div class="text-center mb-12">
              <span class="text-elegant-caps text-or tracking-widest mb-4 block">À lire aussi</span>
              <h2 class="section-title">
                Articles recommandés
              </h2>
              <div class="separator-gold-center mt-6 mb-6"></div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
              {allPosts.map((relatedPost) => (
                <article class="card-elegant hover:scale-[1.02] transition-transform group">
                  <div class="aspect-video bg-creme border border-gris-doux rounded-elegant flex items-center justify-center mb-6 overflow-hidden">
                    {relatedPost.image ? (
                      <img
                        src={relatedPost.image}
                        alt={relatedPost.title}
                        class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
                        loading="lazy"
                      />
                    ) : (
                      <div class="text-center p-6">
                        <div class="icon-container icon-container-lg mx-auto mb-4">
                          {relatedPost.tags.includes('SEO') ? (
                            <Icon name="search" class="icon-gold" size={32} />
                          ) : relatedPost.tags.includes('tarifs') ? (
                            <Icon name="price-tag" class="icon-gold" size={32} />
                          ) : relatedPost.tags.includes('commerce local') ? (
                            <Icon name="storefront" class="icon-gold" size={32} />
                          ) : (
                            <Icon name="document-text" class="icon-gold" size={32} />
                          )}
                        </div>
                        <p class="text-or font-serif font-semibold text-sm">
                          {relatedPost.title.split(' ').slice(0, 3).join(' ')}
                        </p>
                      </div>
                    )}
                  </div>

                  <div class="flex flex-wrap gap-2 mb-3">
                    {relatedPost.tags.slice(0, 2).map((tag: string) => (
                      <span class="text-xs bg-or/10 text-or px-2 py-1 rounded-full capitalize font-semibold">
                        {tag}
                      </span>
                    ))}
                  </div>

                  <h3 class="text-xl font-serif font-bold text-noir mb-3 group-hover:text-or transition-colors">
                    <a href={`/blog/${relatedPost.slug}`}>{relatedPost.title}</a>
                  </h3>

                  <p class="text-charbon mb-4 text-sm line-clamp-2">{relatedPost.description}</p>

                  <a
                    href={`/blog/${relatedPost.slug}`}
                    class="inline-flex items-center text-or font-semibold hover:text-or-light text-sm group/link"
                  >
                    Lire l'article
                    <svg
                      class="w-4 h-4 ml-1 group-hover/link:translate-x-1 transition-transform"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M17 8l4 4m0 0l-4 4m4-4H3"
                      />
                    </svg>
                  </a>
                </article>
              ))}
            </div>

            <div class="text-center mt-12">
              <a href="/blog" class="btn-gold">
                Voir tous les articles
              </a>
            </div>
          </div>
        </div>
      </section>
    )
  }

  <!-- CTA -->
  <CTABlock
    variant="blog"
    title="Besoin d'aide pour votre projet web ?"
    description="Loire Digital accompagne les commerces de Saint-Étienne dans leur transformation digitale. Discutons de votre projet !"
    primaryText="Calculer mon devis"
    secondaryText="Nous contacter"
  />
</BaseLayout>
