---
import BaseLayout from '../../layouts/BaseLayout.astro'
import Icon from '../../components/Icon.astro'
import CTABlock from '../../components/CTABlock.astro'
import { getAllBlogPosts } from '../../lib/blog'

export async function getStaticPaths() {
  const allPosts = await getAllBlogPosts()
  return allPosts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }))
}

const { post } = Astro.props

// Si le post vient d'Astro Content Collections, on doit le rendre
let AstroContent
if (post._source === 'astro' && post._raw) {
  const { Content } = await post._raw.render()
  AstroContent = Content
}

const formatDate = (date: Date) => {
  return new Intl.DateTimeFormat('fr-FR', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  }).format(date)
}

// Get other posts for recommendations
const allPosts = (await getAllBlogPosts())
  .filter((p) => p.slug !== post.slug)
  .slice(0, 2)
---

<BaseLayout title={`${post.title} - Loire Digital`} description={post.description}>
  <!-- Article Schema.org structured data -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "Article",
    "headline": post.title,
    "description": post.description,
    "author": {
      "@type": "Person",
      "name": post.author
    },
    "datePublished": post.pubDate.toISOString(),
    "publisher": {
      "@type": "Organization",
      "name": "Loire Digital",
      "logo": {
        "@type": "ImageObject",
        "url": new URL('/logo.svg', Astro.site).toString()
      }
    },
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": Astro.url.href
    }
  })} />

  <!-- Article Header -->
  <article class="py-12 bg-white">
    <div class="container mx-auto px-4">
      <div class="max-w-4xl mx-auto">
        <!-- Breadcrumb -->
        <nav class="mb-8 text-sm">
          <ol class="flex items-center space-x-2 text-gray-500">
            <li><a href="/" class="hover:text-blue-600 transition-colors">Accueil</a></li>
            <li><span class="mx-2">/</span></li>
            <li><a href="/blog" class="hover:text-blue-600 transition-colors">Blog</a></li>
            <li><span class="mx-2">/</span></li>
            <li class="text-gray-400 truncate">{post.title}</li>
          </ol>
        </nav>

        <!-- Tags -->
        <div class="flex flex-wrap gap-2 mb-6">
          {
            post.tags.map((tag: string) => (
              <span class="text-xs bg-blue-50 text-blue-600 px-3 py-1 rounded-full font-semibold capitalize">
                {tag}
              </span>
            ))
          }
        </div>

        <!-- Title -->
        <h1
          class="text-4xl md:text-6xl font-black text-black mb-6 leading-tight"
          style="letter-spacing: -0.02em;"
        >
          {post.title}
        </h1>

        <!-- Meta -->
        <div class="flex items-center text-gray-text mb-8 pb-8 border-b border-gray-100">
          <div class="flex items-center">
            <div class="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center mr-4">
              <span class="text-white font-bold text-lg">LD</span>
            </div>
            <div>
              <div class="font-semibold text-black">{post.author}</div>
              <div class="text-sm flex items-center text-gray-text">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                  ></path>
                </svg>
                <time datetime={post.pubDate.toISOString()}>
                  {formatDate(post.pubDate)}
                </time>
              </div>
            </div>
          </div>
        </div>

        <!-- Article Content -->
        <div
          class="prose prose-lg max-w-none
          prose-headings:font-black prose-headings:text-black
          prose-p:text-gray-text prose-p:leading-relaxed
          prose-a:text-blue-600 prose-a:no-underline hover:prose-a:text-blue-700
          prose-strong:text-black prose-strong:font-semibold
          prose-ul:text-gray-text prose-ol:text-gray-text
          prose-li:text-gray-text
          prose-code:text-blue-600 prose-code:bg-gray-50 prose-code:px-2 prose-code:py-1 prose-code:rounded
          prose-pre:bg-gray-50 prose-pre:border prose-pre:border-gray-100
          prose-blockquote:border-l-blue-600 prose-blockquote:text-gray-text"
        >
          {post._source === 'astro' && AstroContent ? (
            <AstroContent />
          ) : (
            <Fragment set:html={post.content} />
          )}
        </div>

        <!-- Share Buttons -->
        <div class="mt-12 pt-8 border-t border-gray-100">
          <h3 class="text-lg font-bold text-black mb-4">Partager cet article</h3>
          <div class="flex gap-3">
            <a
              href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(post.title)}&url=${encodeURIComponent(Astro.url.href)}`}
              target="_blank"
              rel="noopener noreferrer"
              class="px-4 py-2 bg-white hover:bg-gray-50 border border-gray-200 rounded-lg text-gray-700 font-medium transition-colors"
            >
              Twitter
            </a>
            <a
              href={`https://www.linkedin.com/shareArticle?mini=true&url=${encodeURIComponent(Astro.url.href)}&title=${encodeURIComponent(post.title)}`}
              target="_blank"
              rel="noopener noreferrer"
              class="px-4 py-2 bg-white hover:bg-gray-50 border border-gray-200 rounded-lg text-gray-700 font-medium transition-colors"
            >
              LinkedIn
            </a>
            <a
              href={`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(Astro.url.href)}`}
              target="_blank"
              rel="noopener noreferrer"
              class="px-4 py-2 bg-white hover:bg-gray-50 border border-gray-200 rounded-lg text-gray-700 font-medium transition-colors"
            >
              Facebook
            </a>
          </div>
        </div>
      </div>
    </div>
  </article>

  <!-- Related Articles -->
  {
    allPosts.length > 0 && (
      <section class="py-20 section-pale">
        <div class="container mx-auto px-4">
          <div class="max-w-5xl mx-auto">
            <h2
              class="text-4xl font-black text-black mb-12 text-center"
              style="letter-spacing: -0.02em;"
            >
              Articles recommandés
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
              {allPosts.map((relatedPost) => (
                <article class="card-minimal hover:scale-[1.02] transition-transform">
                  <div class="aspect-video bg-white border border-gray-100 rounded-xl flex items-center justify-center mb-6 overflow-hidden">
                    <div class="text-center p-6">
                      <div class="w-16 h-16 bg-blue-50 rounded-xl flex items-center justify-center mx-auto mb-4">
                        {relatedPost.tags.includes('SEO') ? (
                          <Icon name="search" class="text-blue-600" size={32} />
                        ) : relatedPost.tags.includes('tarifs') ? (
                          <Icon name="price-tag" class="text-blue-600" size={32} />
                        ) : relatedPost.tags.includes('commerce local') ? (
                          <Icon name="storefront" class="text-blue-600" size={32} />
                        ) : (
                          <Icon name="document-text" class="text-blue-600" size={32} />
                        )}
                      </div>
                      <p class="text-blue-600 font-semibold text-sm">
                        {relatedPost.title.split(' ').slice(0, 3).join(' ')}
                      </p>
                    </div>
                  </div>

                  <div class="flex flex-wrap gap-2 mb-3">
                    {relatedPost.tags.slice(0, 2).map((tag: string) => (
                      <span class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded-full capitalize font-semibold">
                        {tag}
                      </span>
                    ))}
                  </div>

                  <h3 class="text-xl font-bold text-black mb-3 hover:text-blue-600 transition-colors">
                    <a href={`/blog/${relatedPost.slug}`}>{relatedPost.title}</a>
                  </h3>

                  <p class="text-gray-text mb-4 text-sm line-clamp-2">{relatedPost.description}</p>

                  <a
                    href={`/blog/${relatedPost.slug}`}
                    class="inline-flex items-center text-blue-600 font-semibold hover:text-blue-700 text-sm group"
                  >
                    Lire l'article
                    <svg
                      class="w-4 h-4 ml-1 group-hover:translate-x-1 transition-transform"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M17 8l4 4m0 0l-4 4m4-4H3"
                      />
                    </svg>
                  </a>
                </article>
              ))}
            </div>

            <div class="text-center mt-12">
              <a href="/blog" class="btn-primary">
                Voir tous les articles
              </a>
            </div>
          </div>
        </div>
      </section>
    )
  }

  <!-- CTA -->
  <CTABlock
    variant="blog"
    title="Besoin d'aide pour votre projet web ?"
    description="Loire Digital accompagne les commerces de Saint-Étienne dans leur transformation digitale. Discutons de votre projet !"
    primaryText="Calculer mon devis"
    secondaryText="Nous contacter"
  />
</BaseLayout>
